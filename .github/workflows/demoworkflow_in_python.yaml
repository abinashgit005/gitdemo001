name: demoworkflow_in_python
on:
  workflow_dispatch:
  
  push:
    paths:
      - '**/demo.tfvars'

jobs:
  detect-app-rules-changes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # Fetch previous commit to compare

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip install python-hcl2 deepdiff
      - name: Prepare tfvars comparison
        run: |
          mkdir -p tmp
          git show HEAD~1:demo.tfvars > tmp/old.tfvars || touch tmp/old.tfvars
          cp demo.tfvars tmp/new.tfvars

      - name: Run Python diff script
        id: check
        run: |
          result=$(python3 scripts/diff.py)
          echo "$result"
          changed=$(echo "$result" | grep "::set-output name=changed::" | cut -d'=' -f2)
          echo "changed=$changed" >> "$GITHUB_OUTPUT"
    
